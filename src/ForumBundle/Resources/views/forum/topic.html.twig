{% extends '@Forum/layout/layout.html.twig' %}

{% block title %}{{ topic.forum.title }} / {{ topic.title }}{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        $(document).ready(function () {
            $('a.post_delete_button').click(function () {
                var $this = $(this);
                var $deleteForm = $('#delete_popup').find('form');
                $deleteForm.attr('action', $this.attr('data-url'));
            });
            $('a.post_edit_button').click(function () {
                var $this = $(this);
                var $editForm = $('#edit_popup').find('form');
                var refId = $this.data('ref');
                $editForm.find('textarea').val($('#' + refId).text());
                $editForm.attr('action', $this.attr('data-url'));
            });
            $("button[data-id='post_delete_cancel']").click(function () {
                $('#delete_popup').popup('close');
            });
            $("button[data-id='post_edit_cancel']").click(function () {
                $('#edit_popup').popup('close');
            });
        });
    </script>
{% endblock %}

{% block content %}
    {% block popup %}
        <div data-role="popup" id="delete_popup" data-overlay-theme="b" data-theme="b" data-dismissible="false">
            <div data-role="header" data-theme="a">
                <h1>Удалить сообщение?</h1>
            </div>
            <div role="main" class="ui-content">
                <p>Вы уверенны что хотите удалить это сообщение?</p>
                {{ form_start(postDeleteForm) }}
                    {{ form_widget(postDeleteForm) }}
                {{ form_end(postDeleteForm) }}
            </div>
        </div>

        <div data-role="popup" id="edit_popup" data-overlay-theme="b" data-theme="b" data-dismissible="false">
            <div data-role="header" data-theme="a">
                <h1>Редактирование сообщения</h1>
            </div>
            <div role="main" class="ui-content">
                {{ form_start(postEditForm) }}
                    {{ form_widget(postEditForm) }}
                {{ form_end(postEditForm) }}
            </div>
        </div>
    {% endblock %}

    <ul data-role="listview" data-inset="true" data-split-icon="gear" data-split-theme="a">
        {% for post in posts %}
            <li data-role="list-divider">
                <p><a href="{{ path('user_show', {'id': post.user.id }) }}">{{ post.user.username }}</a>: {{ post.createdAt|date }}</p>
                {% if app.user and (is_granted('DELETE', post) or is_granted('EDIT', post)) %}
                    <div data-role="controlgroup" data-type="horizontal" data-mini="true">
                        {% if is_granted('EDIT', post) %}
                            <a data-url="{{ path('post_edit', {'id': post.id}) }}" data-ref="post{{ post.id }}" href="#edit_popup" data-rel="popup" data-transition="slideup" class="post_edit_button ui-btn ui-icon-edit ui-btn-icon-notext">Редактировать</a>
                        {% endif %}
                        {% if is_granted('DELETE', post) %}
                            <a data-url="{{ path('post_delete', {'id': post.id}) }}" href="#delete_popup" data-rel="popup" data-transition="slideup" class="post_delete_button ui-btn ui-icon-delete ui-btn-icon-notext">Удалить</a>
                        {% endif %}
                    </div>
                {% endif %}
            </li>
            <li id="post{{ post.id }}">{{ post.text }}</li>
        {% else %}
            <li>Пусто</li>
        {% endfor %}
    </ul>

    {% include 'ForumBundle:layout:paginate.html.twig' with {'data': posts} %}

    {{ form_start(postCreateForm) }}
        {{ form_widget(postCreateForm) }}
    {{ form_end(postCreateForm) }}

{% endblock %}